<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ziwow.scrmapp.wechat.persistence.mapper.EwCardMapper">



	<resultMap id="BaseEwCardMap" type="com.ziwow.scrmapp.wechat.persistence.entity.EwCard">
		<id column="id" property="id"></id>
		<result column="fans_id" property="fansId"></result>
		<result column="card_no" property="cardNo"></result>
		<result column="purch_date" property="purchDate"></result>
		<result column="repair_term" property="repairTerm"></result>
		<result column="valid_time" property="validTime"></result>
		<result column="product_bar_code_twenty" property="productBarCodeTwenty"></result>
		<result column="card_status" property="cardStatus"></result>
		<result column="install_list" property="installList"></result>
	</resultMap>

	<resultMap id="ewCardMap" type="com.ziwow.scrmapp.wechat.persistence.entity.EwCard" extends="BaseEwCardMap">
		<collection property="ewCardItems" ofType="com.ziwow.scrmapp.wechat.persistence.entity.EwCardItems" column="id">
			<id column="eid" property="id"></id>
			<result column="item_name" property="itemName"></result>
			<result column="item_code" property="itemCode"></result>
		</collection>
	</resultMap>


    <insert id="saveEwCard" parameterType="com.ziwow.scrmapp.wechat.persistence.entity.EwCard" useGeneratedKeys="true" keyProperty="id">
		insert into t_ew_card(fans_id,card_no,purch_date,repair_term,valid_time)
		values(#{fansId},#{cardNo},#{purchDate},#{repairTerm},#{validTime})
	</insert>

	<insert id="saveCompleteEwCard"  useGeneratedKeys="true">
		insert into t_ew_card(fans_id,card_no,purch_date,repair_term,valid_time,product_bar_code_twenty,card_status,install_list)
		values(#{fansId},#{cardNo},#{purchDate},#{repairTerm},#{validTime},#{productBarCodeTwenty},#{cardStatus},#{installList})
	</insert>

	<select id="selectEwCardByNo" resultMap="ewCardMap">
		select ec.*,eci.id eid,eci.item_name,eci.item_code from t_ew_card ec left join t_ew_card_items eci on eci.ew_card_id=ec.id where ec.card_no=#{cardNo}
	</select>

	<select id="selectEwCardByFansId" resultMap="ewCardMap">
		select ec.*,eci.id eid,eci.item_name,eci.item_code from t_ew_card ec left join t_ew_card_items eci on eci.ew_card_id=ec.id where ec.fans_id=#{fansId} and ec.card_status = "NOT_USE"
	</select>

	<select id="selectEwCardByItemNameAndFansId" resultMap="ewCardMap">
		select ec.*,eci.id eid,eci.item_name,eci.item_code from t_ew_card ec left join t_ew_card_items eci on eci.ew_card_id=ec.id where ec.fans_id=#{fansId} and ec.item_name=#{itemName} and ec.card_status = "NOT_USE"
	</select>

	<select id="selectEwCardByCardIds" resultMap="ewCardMap">
		select ec.*,eci.id eid,eci.item_name,eci.item_code from t_ew_card ec left join t_ew_card_items eci on eci.ew_card_id=ec.id where ec.card_status = "NOT_USE"
		and ec.id in
		<foreach collection="cardIds" item="cardId" open="(" close=")" separator=",">
		#{cardId}
		</foreach>
	</select>

	<select id="selectEwCardByNoAndFansId" resultMap="ewCardMap">
		select ec.*,eci.id eid,eci.item_name,eci.item_code from t_ew_card ec left join t_ew_card_items eci on eci.ew_card_id=ec.id where ec.card_no=#{cardNo} and ec.card_status = "NOT_USE" limit 1
	</select>

	<select id="selectEwCardByBarCodeAndFansId" resultMap="ewCardMap">
		select ec.*,eci.id eid,eci.item_name,eci.item_code from t_ew_card ec left join t_ew_card_items eci on eci.ew_card_id=ec.id where ec.fans_id=#{fansId} and ec.product_bar_code_twenty=#{barCode} and ec.card_status != "NOT_USE" order by ec.repair_term desc limit 1
	</select>


	<select id="selectEwCardIdByCodeAndFansId" resultType="Long">
		select ec.id from t_ew_card ec inner join t_ew_card_items eci on eci.ew_card_id=ec.id and eci.item_code=#{productCode} where ec.fans_id=#{fansId}
	</select>


	<update id="updateCard">
		update t_ew_card
		set
		product_bar_code_twenty=#{productBarCode},
		purch_date=#{purchDate},
		repair_term=#{repairTerm},
		card_status=#{cardStatus},
		install_list=#{installList}
		where
		card_no=#{cardNo}
	</update>

	<update id="updateCardStatus">
		update t_ew_card
		set
		card_status=#{ewCardStatus}
		where
		card_no=#{cardNo}
	</update>

	<select id="selectEwCardsByStatus" resultType="string">
		select product_bar_code_twenty from t_ew_card where card_status=#{ewCardStatus}
	</select>

	<select id="selectEwCardsByStatusAndInstall" resultMap="BaseEwCardMap">
		select card_no,product_bar_code_twenty,fans_id,purch_date from t_ew_card where card_status=#{ewCardStatus} and install_list=#{installList}
	</select>

</mapper>