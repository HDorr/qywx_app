<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ziwow.scrmapp.common.persistence.mapper.ProductMapper">
    <resultMap id="BaseResultMap" type="com.ziwow.scrmapp.common.persistence.entity.Product">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="itemKind" jdbcType="VARCHAR" property="itemKind"/>
        <result column="typeName" jdbcType="VARCHAR" property="typeName"/>
        <result column="smallcName" jdbcType="VARCHAR" property="smallcName"/>
        <result column="modelName" jdbcType="VARCHAR" property="modelName"/>
        <result column="levelId" jdbcType="BIGINT" property="levelId"/>
        <result column="levelName" jdbcType="VARCHAR" property="levelName"/>
        <result column="productName" jdbcType="VARCHAR" property="productName"/>
        <result column="productCode" jdbcType="VARCHAR" property="productCode"/>
        <result column="productImage" jdbcType="VARCHAR" property="productImage"/>
        <result column="productBarCode" jdbcType="VARCHAR" property="productBarCode"/>
        <result column="barCodeImage" jdbcType="VARCHAR" property="barCodeImage"/>
        <result column="shoppingOrder" jdbcType="VARCHAR" property="shoppingOrder"/>
        <result column="saleType" jdbcType="INTEGER" property="saleType"/>
        <result column="o2o" jdbcType="INTEGER" property="o2o"/>
        <result column="buyChannel" jdbcType="INTEGER" property="buyChannel"/>
        <result column="filterRemind" jdbcType="INTEGER" property="filterRemind"/>
        <result column="userId" jdbcType="VARCHAR" property="userId"/>
        <result column="buyTime" jdbcType="DATE" property="buyTime"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="createTime" jdbcType="DATE" property="createTime"/>
        <result column="productBarCodeTwenty" jdbcType="VARCHAR" property="productBarCodeTwenty"/>
    </resultMap>
    
    <sql id="Base_Column_List">
	    id, itemKind, typeName, smallcName, modelName, levelId, levelName, productName, productCode, barCodeImage,
	    productImage, productBarCode, shoppingOrder, saleType, o2o, buyChannel, filterRemind, 
	    userId, buyTime, status, createTime,productBarCodeTwenty
	</sql>
	
    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select
        	<include refid="Base_Column_List"/>
        from t_product
        where id = #{id,jdbcType=BIGINT}
    </select>
    
    <select id="findByUserId" resultMap="BaseResultMap" parameterType="java.lang.String">
	    select
	    	id,productName,productBarCode,modelName,levelName,productImage,productBarCodeTwenty
	    from t_product
	    where status = 1 and userId = #{userId} order by id DESC
	</select>
	
    <select id="findBaseInfoById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select id,typeName,itemKind,productName,productBarCode,modelName,levelName,productImage,o2o,buyChannel,shoppingOrder,buyTime,saleType from t_product where id = #{productId,jdbcType=BIGINT}
    </select>
    
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        delete from t_product
        where id = #{id,jdbcType=BIGINT}
    </delete>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="com.ziwow.scrmapp.common.persistence.entity.Product">
	    insert into t_product (
	    	itemKind, typeName, smallcName, modelName, levelId, levelName,
	      	productName, productCode, productImage, productBarCode,barCodeImage, shoppingOrder, saleType,
		    o2o, buyChannel, filterRemind,  userId, buyTime, status, createTime,productBarCodeTwenty
	    )values (
	   		#{itemKind,jdbcType=VARCHAR}, #{typeName,jdbcType=VARCHAR}, #{smallcName,jdbcType=VARCHAR},
		    #{modelName,jdbcType=VARCHAR}, #{levelId,jdbcType=BIGINT}, #{levelName,jdbcType=VARCHAR}, 
		    #{productName,jdbcType=VARCHAR}, #{productCode,jdbcType=VARCHAR}, #{productImage,jdbcType=VARCHAR},
		    #{productBarCode,jdbcType=VARCHAR},#{barCodeImage,jdbcType=VARCHAR}, #{shoppingOrder,jdbcType=VARCHAR}, #{saleType,jdbcType=CHAR},
		    #{o2o,jdbcType=INTEGER}, #{buyChannel,jdbcType=INTEGER}, #{filterRemind,jdbcType=INTEGER},
		    #{userId,jdbcType=VARCHAR}, #{buyTime,jdbcType=DATE}, #{status,jdbcType=INTEGER}, #{createTime,jdbcType=DATE},#{productBarCodeTwenty,jdbcType=VARCHAR}
	    )
	</insert>
	
    <insert id="batchSave" parameterType="java.util.List">
        insert into t_product (itemKind, typeName,
        smallcName, modelName, levelId, levelName,
        productName, productCode, productImage,
        productBarCode, barCodeImage, shoppingOrder, saleType,
        o2o, buyChannel, filterRemind,
        userId, buyTime, status, createTime)
        values
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.itemKind,jdbcType=VARCHAR}, #{item.typeName,jdbcType=VARCHAR}, #{item.smallcName,jdbcType=VARCHAR}
            #{item.modelName,jdbcType=VARCHAR}, #{item.levelId,jdbcType=BIGINT}, #{item.levelName,jdbcType=VARCHAR},
            #{item.productName,jdbcType=VARCHAR}, #{item.productCode,jdbcType=VARCHAR},
            #{item.productImage,jdbcType=VARCHAR},#{item.productBarCode,jdbcType=VARCHAR},
            #{barCodeImage,jdbcType=VARCHAR},#{item.shoppingOrder,jdbcType=VARCHAR},#{item.saleType,jdbcType=CHAR},
            #{item.o2o,jdbcType=INTEGER}, #{item.buyChannel,jdbcType=INTEGER}, #{item.filterRemind,jdbcType=INTEGER},
            #{item.userId,jdbcType=VARCHAR}, #{item.buyTime,jdbcType=DATE}, #{item.status,jdbcType=INTEGER},
            #{createTime,jdbcType=DATE}
            )
        </foreach>
    </insert>

    <insert id="insertSelective" parameterType="com.ziwow.scrmapp.common.persistence.entity.Product">
        insert into t_product
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="itemKind != null">
                itemKind,
            </if>
            <if test="typeName != null">
                typeName,
            </if>
            <if test="smallcName != null">
                smallcName,
            </if>
            <if test="modelName != null">
                modelName,
            </if>
            <if test="levelId != null">
                levelId,
            </if>
            <if test="levelName != null">
                levelName,
            </if>
            <if test="productName != null">
                productName,
            </if>
            <if test="productCode != null">
                productCode,
            </if>
            <if test="productImage != null">
                productImage,
            </if>
            <if test="productBarCode != null">
                productBarCode,
            </if>
            <if test="barCodeImage != null">
                barCodeImage,
            </if>
            <if test="shoppingOrder != null">
                shoppingOrder,
            </if>
            <if test="saleType != null">
                saleType,
            </if>
            <if test="o2o != null">
                o2o,
            </if>
            <if test="buyChannel != null">
                buyChannel,
            </if>
            <if test="filterRemind != null">
                filterRemind,
            </if>
            <if test="userId != null">
                userId,
            </if>
            <if test="buyTime != null">
                buyTime,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="createTime != null">
                createTime,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=BIGINT},
            </if>
            <if test="itemKind != null">
                #{itemKind,jdbcType=VARCHAR},
            </if>
            <if test="typeName != null">
                #{typeName,jdbcType=VARCHAR},
            </if>
            <if test="smallcName != null">
                #{smallcName,jdbcType=VARCHAR},
            </if>
            <if test="modelName != null">
                #{modelName,jdbcType=VARCHAR},
            </if>
            <if test="levelId != null">
                #{levelId,jdbcType=BIGINT},
            </if>
            <if test="levelName != null">
                #{levelName,jdbcType=VARCHAR},
            </if>
            <if test="productName != null">
                #{productName,jdbcType=VARCHAR},
            </if>
            <if test="productCode != null">
                #{productCode,jdbcType=VARCHAR},
            </if>
            <if test="productImage != null">
                #{productImage,jdbcType=VARCHAR},
            </if>
            <if test="productBarCode != null">
                #{productBarCode,jdbcType=VARCHAR},
            </if>
            <if test="barCodeImage != null">
                #{barCodeImage,jdbcType=VARCHAR},
            </if>
            <if test="shoppingOrder != null">
                #{shoppingOrder,jdbcType=VARCHAR},
            </if>
            <if test="saleType != null">
                #{saleType,jdbcType=CHAR},
            </if>
            <if test="o2o != null">
                #{o2o,jdbcType=INTEGER},
            </if>
            <if test="buyChannel != null">
                #{buyChannel,jdbcType=INTEGER},
            </if>
            <if test="filterRemind != null">
                #{filterRemind,jdbcType=INTEGER},
            </if>
            <if test="userId != null">
                #{userId,jdbcType=VARCHAR},
            </if>
            <if test="buyTime != null">
                #{buyTime,jdbcType=DATE},
            </if>
            <if test="status != null">
                #{status,jdbcType=INTEGER},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=DATE},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.ziwow.scrmapp.common.persistence.entity.Product">
        update t_product
        <set>
            <if test="itemKind != null">
                itemKind = #{itemKind,jdbcType=VARCHAR},
            </if>
            <if test="typeName != null">
                typeName = #{typeName,jdbcType=VARCHAR},
            </if>
            <if test="smallcName != null">
                typeName = #{smallcName,jdbcType=VARCHAR},
            </if>
            <if test="modelName != null">
                modelName = #{modelName,jdbcType=VARCHAR},
            </if>
            <if test="levelId != null">
                levelId = #{levelId,jdbcType=BIGINT},
            </if>
            <if test="levelName != null">
                levelName = #{levelName,jdbcType=VARCHAR},
            </if>
            <if test="productName != null">
                productName = #{productName,jdbcType=VARCHAR},
            </if>
            <if test="productCode != null">
                productCode = #{productCode,jdbcType=VARCHAR},
            </if>
            <if test="productImage != null">
                productImage = #{productImage,jdbcType=VARCHAR},
            </if>
            <if test="productBarCode != null">
                productBarCode = #{productBarCode,jdbcType=VARCHAR},
            </if>
            <if test="barCodeImage != null">
                barCodeImage = #{barCodeImage,jdbcType=VARCHAR},
            </if>
            <if test="shoppingOrder != null">
                shoppingOrder = #{shoppingOrder,jdbcType=VARCHAR},
            </if>
            <if test="saleType != null">
                saleType = #{saleType,jdbcType=CHAR},
            </if>
            <if test="o2o != null">
                o2o = #{o2o,jdbcType=INTEGER},
            </if>
            <if test="buyChannel != null">
                buyChannel = #{buyChannel,jdbcType=INTEGER},
            </if>
            <if test="filterRemind != null">
                filterRemind = #{filterRemind,jdbcType=INTEGER},
            </if>
            <if test="userId != null">
                userId = #{userId,jdbcType=VARCHAR},
            </if>
            <if test="buyTime != null">
                buyTime = #{buyTime,jdbcType=DATE},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=INTEGER},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=DATE},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.ziwow.scrmapp.common.persistence.entity.Product">
        update t_product
        set itemKind = #{itemKind,jdbcType=VARCHAR},
        typeName = #{typeName,jdbcType=VARCHAR},;
        smallcName = #{smallcName,jdbcType=VARCHAR},
        modelName = #{modelName,jdbcType=VARCHAR},
        levelId = #{levelId,jdbcType=BIGINT},
        levelName = #{levelName,jdbcType=VARCHAR},
        productName = #{productName,jdbcType=VARCHAR},
        productCode = #{productCode,jdbcType=VARCHAR},
        productImage = #{productImage,jdbcType=VARCHAR},
        productBarCode = #{productBarCode,jdbcType=VARCHAR},
        barCodeImage = #{barCodeImage,jdbcType=VARCHAR},
        shoppingOrder = #{shoppingOrder,jdbcType=VARCHAR},
        saleType = #{saleType,jdbcType=CHAR},
        o2o = #{o2o,jdbcType=INTEGER},
        buyChannel = #{buyChannel,jdbcType=INTEGER},
        filterRemind = #{filterRemind,jdbcType=INTEGER},
        userId = #{userId,jdbcType=VARCHAR},
        buyTime = #{buyTime,jdbcType=DATE},
        status = #{status,jdbcType=INTEGER},
        createTime = #{createTime,jdbcType=DATE}
        where id = #{id,jdbcType=BIGINT}
    </update>

    <update id="updateProductImg">
        update t_product
        set productImage = #{productImage,jdbcType=VARCHAR}
        where modelName = #{modelName,jdbcType=VARCHAR}
    </update>

    <update id="updateRemind">
        update t_product
        set filterRemind = #{filterRemind,jdbcType=INTEGER}
        where id = #{productId,jdbcType=BIGINT}
    </update>

    <update id="updateStatus">
        update t_product
        set status = 2
        where userId = #{userId,jdbcType=VARCHAR} and id = #{productId,jdbcType=BIGINT}
    </update>

    <update id="updateBarCode">
		UPDATE t_product
		SET productBarCodeTwenty = #{productBarCode,jdbcType=VARCHAR}, barCodeImage = #{barCodeImage,jdbcType=VARCHAR}
		WHERE id = #{productId,jdbcType=BIGINT}
    </update>

	<update id="updateProductBarCode" parameterType="com.ziwow.scrmapp.common.bean.vo.ProductVo">
		UPDATE t_product
		SET productBarCodeTwenty = #{productBarCode,jdbcType=VARCHAR}, barCodeImage = #{barCodeImage,jdbcType=VARCHAR}
		<if test="productBarCodeTwenty != null and productBarCodeTwenty != ''">
           ,productBarCode = #{productBarCodeTwenty,jdbcType=VARCHAR}
        </if>
		WHERE id = #{productId,jdbcType=BIGINT}
    </update>

    <update id="updateBarCodeImage">
        update t_product set barCodeImage = #{barCodeImage,jdbcType=VARCHAR}
        where id = #{productId,jdbcType=BIGINT}
    </update>

    <select id="isBindProduct" resultType="java.lang.Integer">
        select count(*)  from t_product where userId = #{userId,jdbcType=VARCHAR}
        and productBarCode = #{barCode,jdbcType=VARCHAR} and status = 1
    </select>

    <update id="updateUserIdById">
        update t_product set userId = #{userId,jdbcType=VARCHAR}
        where id = #{productId,jdbcType=BIGINT}
    </update>

    <select id="selectByOrdersIds" resultType="com.ziwow.scrmapp.common.bean.vo.ProductVo">
        SELECT
        opr.orderId AS ordersId,
        opr.status,
        p.typeName AS typeName,
        p.smallcName AS smallcName,
        p.id AS productId,
        p.productName AS productName,
        p.productImage as productImage,
        p.productBarCode AS productBarCode,
        p.modelName AS modelName,
        p.productImage AS productImage,
        p.saleType AS saleType,
        p.levelId,
        p.productCode,
        p.productBarCodeTwenty
        FROM
        t_product p,
        t_orders_pro_relations opr
        WHERE
        opr.productId = p.id
        AND
        opr.orderId IN
        <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectByOrdersId" resultType="com.ziwow.scrmapp.common.bean.vo.ProductVo"
            parameterType="java.lang.Long">
        SELECT
        p.id as productId,
        p.productName AS productName,
        p.productCode AS productCode,
        p.productBarCode AS productBarCode,
        p.modelName AS modelName,
        p.typeName AS typeName,
        p.levelId as levelId,
        p.itemKind as itemKind,
        p.o2o,
        p.shoppingOrder,
        p.buyChannel,
        p.saleType,
        p.productBarCodeTwenty,
        opr.status
        FROM
        t_product p,
        t_orders_pro_relations opr
        WHERE
        opr.productId = p.id
        AND opr.orderId = #{ordersId}
    </select>

    <select id="getProductInfoById" parameterType="java.util.List" resultType="com.ziwow.scrmapp.common.bean.vo.ProductVo">
        SELECT
        id as productId,
        levelId,
        productName,
        typeName,
        productBarCode,
        modelName,
        productImage,
        itemKind,
        o2o,
        buyChannel,
        productCode,
        buyTime,
        shoppingOrder,
        saleType,
        productBarCodeTwenty
        FROM
        t_product
        WHERE
        id
        <trim prefix="in (" suffix=")" suffixOverrides=",">
            <foreach collection="list" item="productId" index="index" separator=",">
                #{productId,jdbcType=BIGINT}
            </foreach>
        </trim>
    </select>

    <select id="getFinishedOrdersDetail" resultType="com.ziwow.scrmapp.common.bean.vo.ProductFinishVo">
        SELECT
            CASE opr.status
				WHEN 1 THEN '正常'
				WHEN 2 THEN '退单'
				WHEN 3 THEN '已完工'
			END status,
			p.productName,
			p.productBarCode,
			p.productBarCodeTwenty,
			p.modelName,
			p.barCodeImage productImage,
			cr.changeItem,
			cr.changeCost,
			mr.maintainItem,
			mr.maintainCost,
			ir.record itemRecord,
			pr.record partRecord
		FROM
			t_orders_pro_relations opr
		LEFT JOIN t_product p ON opr.productId = p.id
		LEFT JOIN t_filter_change_record cr ON opr.productId = cr.productId AND opr.orderId = cr.orderId
		LEFT JOIN t_maintain_record mr ON opr.productId = mr.productId AND opr.orderId = mr.orderId
		LEFT JOIN t_repair_item_record ir ON opr.productId = ir.productId AND opr.orderId = ir.orderId
		LEFT JOIN t_repair_part_record pr ON opr.productId = pr.productId AND opr.orderId = pr.orderId
		WHERE
			opr.orderId = #{ordersId}
    </select>
    <select id="countProductByUserIdWithoutStatus" resultType="java.lang.Integer">
        select count(*) from t_product
        where userId=#{userId}
    </select>

    <update id="updateSmallcNameByOrderCode">
        update t_product set smallcName = #{smallcName,jdbcType=VARCHAR}
        where productCode = #{productCode,jdbcType=VARCHAR} and smallcName is null
    </update>

</mapper>